#!/usr/bin/env bash
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"
cd "$repo_root"

run_nonblocking() {
  local label="$1"
  shift
  if "$@"; then
    return 0
  fi
  local status=$?
  echo "WARNING: pre-commit: ${label} failed with exit code ${status}. Commit will proceed." >&2
  return 0
}

staged_files="$(git diff --cached --name-only --diff-filter=ACM)"

if [[ -n "$staged_files" ]]; then
  lint_files=()
  while IFS= read -r file; do
    [[ -n "$file" ]] && lint_files+=("$file")
  done < <(printf "%s\n" "$staged_files" | grep -E '\.(ts|tsx|js|jsx)$' || true)

  if (( ${#lint_files[@]} > 0 )); then
    run_nonblocking "eslint --fix" npx eslint --fix "${lint_files[@]}"
  fi
fi

run_nonblocking "npm run format" npm run format --silent -- --log-level warn

if [[ -n "$staged_files" ]]; then
  while IFS= read -r file; do
    [[ -n "$file" ]] && git add "$file"
  done <<< "$staged_files"
else
  git add --update
fi
